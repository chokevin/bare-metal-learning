name: TLA+ Model Checking

on:
  push:
    branches: [ main, master ]
    paths:
      - 'kubernetes/tla/**/*.tla'
      - 'kubernetes/tla/**/*.cfg'
      - '.github/workflows/tla-check.yml'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'kubernetes/tla/**/*.tla'
      - 'kubernetes/tla/**/*.cfg'
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  tla-check:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    strategy:
      fail-fast: false
      matrix:
        worker: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: Install TLA+ Tools
      run: |
        wget https://github.com/tlaplus/tlaplus/releases/download/v1.8.0/tla2tools.jar
        echo "TLA2TOOLS_JAR=$(pwd)/tla2tools.jar" >> $GITHUB_ENV
    
    - name: Run TLC worker ${{ matrix.worker }} of 20
      run: |
        cd kubernetes/tla
        # Use seed-based partitioning to distribute work across workers
        # Each worker uses a different seed to explore different parts of the state space
        SEED=$((1000000 + ${{ matrix.worker }} * 12345))
        java -XX:+UseParallelGC -Xmx6g -cp $TLA2TOOLS_JAR tlc2.TLC \
          -workers auto \
          -seed $SEED \
          -simulate num=250000 \
          -depth 100 \
          -config dpu_multi_tenant.cfg \
          dpu_multi_tenant.tla \
          2>&1 | tee tlc_worker_${{ matrix.worker }}.log
    
    - name: Check for errors in TLC output
      if: always()
      run: |
        cd kubernetes/tla
        if grep -q "Error:" tlc_worker_${{ matrix.worker }}.log; then
          echo "❌ TLC found an error in worker ${{ matrix.worker }}!"
          grep -A 20 "Error:" tlc_worker_${{ matrix.worker }}.log
          exit 1
        fi
        if grep -q "Invariant.*is violated" tlc_worker_${{ matrix.worker }}.log; then
          echo "❌ Invariant violation found in worker ${{ matrix.worker }}!"
          grep -A 20 "violated" tlc_worker_${{ matrix.worker }}.log
          exit 1
        fi
        if grep -q "Temporal properties were violated" tlc_worker_${{ matrix.worker }}.log; then
          echo "❌ Temporal property violation found in worker ${{ matrix.worker }}!"
          grep -A 20 "Temporal properties" tlc_worker_${{ matrix.worker }}.log
          exit 1
        fi
        if grep -q "Finished.*00s" tlc_worker_${{ matrix.worker }}.log && ! grep -q "states generated" tlc_worker_${{ matrix.worker }}.log; then
          echo "❌ TLC finished too quickly, possibly crashed in worker ${{ matrix.worker }}"
          exit 1
        fi
        echo "✅ Worker ${{ matrix.worker }} completed successfully with no errors"
        echo "States checked:" $(grep -oP 'The number of states generated: \K[0-9]+' tlc_worker_${{ matrix.worker }}.log || echo "N/A")
        echo "Traces generated:" $(grep -oP 'Progress:.*\K[0-9]+ traces' tlc_worker_${{ matrix.worker }}.log | head -1 || echo "N/A")
    
    - name: Upload TLC output for worker ${{ matrix.worker }}
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: tlc-output-worker-${{ matrix.worker }}
        path: |
          kubernetes/tla/states/
          kubernetes/tla/*.out
          kubernetes/tla/tlc_worker_${{ matrix.worker }}.log
        retention-days: 30
